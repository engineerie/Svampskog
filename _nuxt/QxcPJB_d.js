import{u as O,g as _,a as F,b as L,s as U,c as H,d as N,e as W}from"./BzkLERY1.js";import"./B3YaUdZU.js";import"./Bt5P45U8.js";import{D as E,E as z,G as J,m as $,p as x,H as G}from"./CnQw2CUy.js";import{c as q}from"./BcuaSPJk.js";import"./C-h6wg6k.js";import"./Cpj98o6Y.js";import"./CV4Hssdo.js";function V(r){return!r||typeof r.then!="function"?Promise.resolve(r):r}function h(r,...o){try{return V(r(...o))}catch(i){return Promise.reject(i)}}function Q(r){const o=typeof r;return r===null||o!=="object"&&o!=="function"}function X(r){const o=Object.getPrototypeOf(r);return!o||o.isPrototypeOf(Object)}function S(r){if(Q(r))return String(r);if(X(r)||Array.isArray(r))return JSON.stringify(r);if(typeof r.toJSON=="function")return S(r.toJSON());throw new Error("[unstorage] Cannot stringify value!")}const K="base64:";function Y(r){return typeof r=="string"?r:K+ee(r)}function Z(r){return typeof r!="string"||!r.startsWith(K)?r:k(r.slice(K.length))}function k(r){return globalThis.Buffer?Buffer.from(r,"base64"):Uint8Array.from(globalThis.atob(r),o=>o.codePointAt(0))}function ee(r){return globalThis.Buffer?Buffer.from(r).toString("base64"):globalThis.btoa(String.fromCodePoint(...r))}function w(r){return r&&r.split("?")[0]?.replace(/[/\\]/g,":").replace(/:+/g,":").replace(/^:|:$/g,"")||""}function te(...r){return w(r.join(":"))}function T(r){return r=w(r),r?r+":":""}function re(r,o){if(o===void 0)return!0;let i=0,d=r.indexOf(":");for(;d>-1;)i++,d=r.indexOf(":",d+1);return i<=o}function oe(r,o){return o?r.startsWith(o)&&r[r.length-1]!=="$":r[r.length-1]!=="$"}const ne="memory",se=()=>{const r=new Map;return{name:ne,getInstance:()=>r,hasItem(o){return r.has(o)},getItem(o){return r.get(o)??null},getItemRaw(o){return r.get(o)??null},setItem(o,i){r.set(o,i)},setItemRaw(o,i){r.set(o,i)},removeItem(o){r.delete(o)},getKeys(){return[...r.keys()]},clear(){r.clear()},dispose(){r.clear()}}};function ie(r={}){const o={mounts:{"":r.driver||se()},mountpoints:[""],watching:!1,watchListeners:[],unwatch:{}},i=t=>{for(const e of o.mountpoints)if(t.startsWith(e))return{base:e,relativeKey:t.slice(e.length),driver:o.mounts[e]};return{base:"",relativeKey:t,driver:o.mounts[""]}},d=(t,e)=>o.mountpoints.filter(n=>n.startsWith(t)||e&&t.startsWith(n)).map(n=>({relativeBase:t.length>n.length?t.slice(n.length):void 0,mountpoint:n,driver:o.mounts[n]})),p=(t,e)=>{if(o.watching){e=w(e);for(const n of o.watchListeners)n(t,e)}},c=async()=>{if(!o.watching){o.watching=!0;for(const t in o.mounts)o.unwatch[t]=await j(o.mounts[t],p,t)}},f=async()=>{if(o.watching){for(const t in o.unwatch)await o.unwatch[t]();o.unwatch={},o.watching=!1}},a=(t,e,n)=>{const s=new Map,u=l=>{let y=s.get(l.base);return y||(y={driver:l.driver,base:l.base,items:[]},s.set(l.base,y)),y};for(const l of t){const y=typeof l=="string",g=w(y?l:l.key),D=y?void 0:l.value,I=y||!l.options?e:{...e,...l.options},b=i(g);u(b).items.push({key:g,value:D,relativeKey:b.relativeKey,options:I})}return Promise.all([...s.values()].map(l=>n(l))).then(l=>l.flat())},m={hasItem(t,e={}){t=w(t);const{relativeKey:n,driver:s}=i(t);return h(s.hasItem,n,e)},getItem(t,e={}){t=w(t);const{relativeKey:n,driver:s}=i(t);return h(s.getItem,n,e).then(u=>E(u))},getItems(t,e={}){return a(t,e,n=>n.driver.getItems?h(n.driver.getItems,n.items.map(s=>({key:s.relativeKey,options:s.options})),e).then(s=>s.map(u=>({key:te(n.base,u.key),value:E(u.value)}))):Promise.all(n.items.map(s=>h(n.driver.getItem,s.relativeKey,s.options).then(u=>({key:s.key,value:E(u)})))))},getItemRaw(t,e={}){t=w(t);const{relativeKey:n,driver:s}=i(t);return s.getItemRaw?h(s.getItemRaw,n,e):h(s.getItem,n,e).then(u=>Z(u))},async setItem(t,e,n={}){if(e===void 0)return m.removeItem(t);t=w(t);const{relativeKey:s,driver:u}=i(t);u.setItem&&(await h(u.setItem,s,S(e),n),u.watch||p("update",t))},async setItems(t,e){await a(t,e,async n=>{if(n.driver.setItems)return h(n.driver.setItems,n.items.map(s=>({key:s.relativeKey,value:S(s.value),options:s.options})),e);n.driver.setItem&&await Promise.all(n.items.map(s=>h(n.driver.setItem,s.relativeKey,S(s.value),s.options)))})},async setItemRaw(t,e,n={}){if(e===void 0)return m.removeItem(t,n);t=w(t);const{relativeKey:s,driver:u}=i(t);if(u.setItemRaw)await h(u.setItemRaw,s,e,n);else if(u.setItem)await h(u.setItem,s,Y(e),n);else return;u.watch||p("update",t)},async removeItem(t,e={}){typeof e=="boolean"&&(e={removeMeta:e}),t=w(t);const{relativeKey:n,driver:s}=i(t);s.removeItem&&(await h(s.removeItem,n,e),(e.removeMeta||e.removeMata)&&await h(s.removeItem,n+"$",e),s.watch||p("remove",t))},async getMeta(t,e={}){typeof e=="boolean"&&(e={nativeOnly:e}),t=w(t);const{relativeKey:n,driver:s}=i(t),u=Object.create(null);if(s.getMeta&&Object.assign(u,await h(s.getMeta,n,e)),!e.nativeOnly){const l=await h(s.getItem,n+"$",e).then(y=>E(y));l&&typeof l=="object"&&(typeof l.atime=="string"&&(l.atime=new Date(l.atime)),typeof l.mtime=="string"&&(l.mtime=new Date(l.mtime)),Object.assign(u,l))}return u},setMeta(t,e,n={}){return this.setItem(t+"$",e,n)},removeMeta(t,e={}){return this.removeItem(t+"$",e)},async getKeys(t,e={}){t=T(t);const n=d(t,!0);let s=[];const u=[];let l=!0;for(const g of n){g.driver.flags?.maxDepth||(l=!1);const D=await h(g.driver.getKeys,g.relativeBase,e);for(const I of D){const b=g.mountpoint+w(I);s.some(C=>b.startsWith(C))||u.push(b)}s=[g.mountpoint,...s.filter(I=>!I.startsWith(g.mountpoint))]}const y=e.maxDepth!==void 0&&!l;return u.filter(g=>(!y||re(g,e.maxDepth))&&oe(g,t))},async clear(t,e={}){t=T(t),await Promise.all(d(t,!1).map(async n=>{if(n.driver.clear)return h(n.driver.clear,n.relativeBase,e);if(n.driver.removeItem){const s=await n.driver.getKeys(n.relativeBase||"",e);return Promise.all(s.map(u=>n.driver.removeItem(u,e)))}}))},async dispose(){await Promise.all(Object.values(o.mounts).map(t=>A(t)))},async watch(t){return await c(),o.watchListeners.push(t),async()=>{o.watchListeners=o.watchListeners.filter(e=>e!==t),o.watchListeners.length===0&&await f()}},async unwatch(){o.watchListeners=[],await f()},mount(t,e){if(t=T(t),t&&o.mounts[t])throw new Error(`already mounted at ${t}`);return t&&(o.mountpoints.push(t),o.mountpoints.sort((n,s)=>s.length-n.length)),o.mounts[t]=e,o.watching&&Promise.resolve(j(e,p,t)).then(n=>{o.unwatch[t]=n}).catch(console.error),m},async unmount(t,e=!0){t=T(t),!(!t||!o.mounts[t])&&(o.watching&&t in o.unwatch&&(o.unwatch[t]?.(),delete o.unwatch[t]),e&&await A(o.mounts[t]),o.mountpoints=o.mountpoints.filter(n=>n!==t),delete o.mounts[t])},getMount(t=""){t=w(t)+":";const e=i(t);return{driver:e.driver,base:e.base}},getMounts(t="",e={}){return t=w(t),d(t,e.parents).map(s=>({driver:s.driver,base:s.mountpoint}))},keys:(t,e={})=>m.getKeys(t,e),get:(t,e={})=>m.getItem(t,e),set:(t,e,n={})=>m.setItem(t,e,n),has:(t,e={})=>m.hasItem(t,e),del:(t,e={})=>m.removeItem(t,e),remove:(t,e={})=>m.removeItem(t,e)};return m}function j(r,o,i){return r.watch?r.watch((d,p)=>o(d,i+p)):()=>{}}async function A(r){typeof r.dispose=="function"&&await h(r.dispose)}class ae extends Error{constructor(o,i){super(o,i),this.name="FetchError",i?.cause&&!this.cause&&(this.cause=i.cause)}}function ce(r){const o=r.error?.message||r.error?.toString()||"",i=r.request?.method||r.options?.method||"GET",d=r.request?.url||String(r.request)||"/",p=`[${i}] ${JSON.stringify(d)}`,c=r.response?`${r.response.status} ${r.response.statusText}`:"<no response>",f=`${p}: ${c}${o?` ${o}`:""}`,a=new ae(f,r.error?{cause:r.error}:void 0);for(const m of["request","options","response"])Object.defineProperty(a,m,{get(){return r[m]}});for(const[m,t]of[["data","_data"],["status","status"],["statusCode","status"],["statusText","statusText"],["statusMessage","statusText"]])Object.defineProperty(a,m,{get(){return r.response&&r.response[t]}});return a}const ue=new Set(Object.freeze(["PATCH","POST","PUT","DELETE"]));function B(r="GET"){return ue.has(r.toUpperCase())}function fe(r){if(r===void 0)return!1;const o=typeof r;return o==="string"||o==="number"||o==="boolean"||o===null?!0:o!=="object"?!1:Array.isArray(r)?!0:r.buffer||r instanceof FormData||r instanceof URLSearchParams?!1:r.constructor&&r.constructor.name==="Object"||typeof r.toJSON=="function"}const pe=new Set(["image/svg","application/xml","application/xhtml","application/html"]),le=/^application\/(?:[\w!#$%&*.^`~-]*\+)?json(;.+)?$/i;function me(r=""){if(!r)return"json";const o=r.split(";").shift()||"";return le.test(o)?"json":o==="text/event-stream"?"stream":pe.has(o)||o.startsWith("text/")?"text":"blob"}function de(r,o,i,d){const p=he(o?.headers??r?.headers,i?.headers,d);let c;return(i?.query||i?.params||o?.params||o?.query)&&(c={...i?.params,...i?.query,...o?.params,...o?.query}),{...i,...o,query:c,params:c,headers:p}}function he(r,o,i){if(!o)return new i(r);const d=new i(o);if(r)for(const[p,c]of Symbol.iterator in r||Array.isArray(r)?r:new i(r))d.set(p,c);return d}async function R(r,o){if(o)if(Array.isArray(o))for(const i of o)await i(r);else await o(r)}const ye=new Set([408,409,425,429,500,502,503,504]),we=new Set([101,204,205,304]);function M(r={}){const{fetch:o=globalThis.fetch,Headers:i=globalThis.Headers,AbortController:d=globalThis.AbortController}=r;async function p(a){const m=a.error&&a.error.name==="AbortError"&&!a.options.timeout||!1;if(a.options.retry!==!1&&!m){let e;typeof a.options.retry=="number"?e=a.options.retry:e=B(a.options.method)?0:1;const n=a.response&&a.response.status||500;if(e>0&&(Array.isArray(a.options.retryStatusCodes)?a.options.retryStatusCodes.includes(n):ye.has(n))){const s=typeof a.options.retryDelay=="function"?a.options.retryDelay(a):a.options.retryDelay||0;return s>0&&await new Promise(u=>setTimeout(u,s)),c(a.request,{...a.options,retry:e-1})}}const t=ce(a);throw Error.captureStackTrace&&Error.captureStackTrace(t,c),t}const c=async function(m,t={}){const e={request:m,options:de(m,t,r.defaults,i),response:void 0,error:void 0};if(e.options.method&&(e.options.method=e.options.method.toUpperCase()),e.options.onRequest&&(await R(e,e.options.onRequest),e.options.headers instanceof i||(e.options.headers=new i(e.options.headers||{}))),typeof e.request=="string"&&(e.options.baseURL&&(e.request=z(e.request,e.options.baseURL)),e.options.query&&(e.request=J(e.request,e.options.query),delete e.options.query),"query"in e.options&&delete e.options.query,"params"in e.options&&delete e.options.params),e.options.body&&B(e.options.method))if(fe(e.options.body)){const u=e.options.headers.get("content-type");typeof e.options.body!="string"&&(e.options.body=u==="application/x-www-form-urlencoded"?new URLSearchParams(e.options.body).toString():JSON.stringify(e.options.body)),u||e.options.headers.set("content-type","application/json"),e.options.headers.has("accept")||e.options.headers.set("accept","application/json")}else("pipeTo"in e.options.body&&typeof e.options.body.pipeTo=="function"||typeof e.options.body.pipe=="function")&&("duplex"in e.options||(e.options.duplex="half"));let n;if(!e.options.signal&&e.options.timeout){const u=new d;n=setTimeout(()=>{const l=new Error("[TimeoutError]: The operation was aborted due to timeout");l.name="TimeoutError",l.code=23,u.abort(l)},e.options.timeout),e.options.signal=u.signal}try{e.response=await o(e.request,e.options)}catch(u){return e.error=u,e.options.onRequestError&&await R(e,e.options.onRequestError),await p(e)}finally{n&&clearTimeout(n)}if((e.response.body||e.response._bodyInit)&&!we.has(e.response.status)&&e.options.method!=="HEAD"){const u=(e.options.parseResponse?"json":e.options.responseType)||me(e.response.headers.get("content-type")||"");switch(u){case"json":{const l=await e.response.text(),y=e.options.parseResponse||E;e.response._data=y(l);break}case"stream":{e.response._data=e.response.body||e.response._bodyInit;break}default:e.response._data=await e.response[u]()}}return e.options.onResponse&&await R(e,e.options.onResponse),!e.options.ignoreResponseError&&e.response.status>=400&&e.response.status<600?(e.options.onResponseError&&await R(e,e.options.onResponseError),await p(e)):e.response},f=async function(m,t){return(await c(m,t))._data};return f.raw=c,f.native=(...a)=>o(...a),f.create=(a={},m={})=>M({...r,...m,defaults:{...r.defaults,...m.defaults,...a}}),f}const P=(function(){if(typeof globalThis<"u")return globalThis;if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")})(),ge=P.fetch?(...r)=>P.fetch(...r):()=>Promise.reject(new Error("[ofetch] global.fetch is not supported!")),ve=P.Headers,Ie=P.AbortController,be=M({fetch:ge,Headers:ve,AbortController:Ie}),v=be,Ee="http",Te=r=>{const o=(c="")=>$(r.base,c.replace(/:/g,"/")),i=(c="")=>$(r.base,(c||"/").replace(/:/g,"/"),":"),d=(c,f=null)=>{if(c?.response?.status===404)return f;throw c},p=(c,f)=>{const a={...f,...r.headers,...c?.headers};return c?.ttl&&!a["x-ttl"]&&(a["x-ttl"]=c.ttl+""),a};return{name:Ee,options:r,hasItem(c,f){return v(o(c),{method:"HEAD",headers:p(f)}).then(()=>!0).catch(a=>d(a,!1))},async getItem(c,f){return await v(o(c),{headers:p(f)}).catch(d)},async getItemRaw(c,f){return(await v.raw(o(c),{responseType:"arrayBuffer",headers:p(f,{accept:"application/octet-stream"})}).catch(d))._data},async getMeta(c,f){const a=await v.raw(o(c),{method:"HEAD",headers:p(f)});let m,t;const e=a.headers.get("last-modified");e&&(m=new Date(e));const n=a.headers.get("x-ttl");return n&&(t=Number.parseInt(n,10)),{status:a.status,mtime:m,ttl:t}},async setItem(c,f,a){await v(o(c),{method:"PUT",body:f,headers:p(a)})},async setItemRaw(c,f,a){await v(o(c),{method:"PUT",body:f,headers:p(a,{"content-type":"application/octet-stream"})})},async removeItem(c,f){await v(o(c),{method:"DELETE",headers:p(f)})},async getKeys(c,f){const a=await v(i(c),{headers:p(f)});return Array.isArray(a)?a:[]},async clear(c,f){await v(i(c),{method:"DELETE",headers:p(f)})}}};function Ae(r,o){const i=O(r,o);if(!x().public.studio.dev)return i;i.meta.dev=!0;const d=ie({driver:Te({base:"/__nuxt_studio/dev/content"})});return i.app.requestRerender=()=>{},i.document.db.upsert=G(async(p,c)=>{const f=_(p,q);if(!f)throw new Error(`Collection not found for fsPath: ${p}`);const a=F(p,f),m=L(a,f,c),t=U(m,f),e=await i.document.generate.contentFromDocument(t);await $fetch("/__nuxt_studio/dev/content/"+p,{method:"PUT",body:e,headers:{"content-type":"text/plain"},timeout:100}).catch(()=>{})},100),i.document.db.delete=async p=>{await d.removeItem(p)},i.on.documentUpdate=p=>{(void 0).on("nuxt-content:update",c=>{const f=H(c.key,q),a=N(c.key,f.source),m=W(c.key,a),t=c.queries.length===0;p(m,t?"remove":"update")})},i.on.mediaUpdate=p=>{(void 0).on("nuxt-studio:media:update",c=>{p(c.id,c.type)})},i}export{Ae as useStudioHost};
