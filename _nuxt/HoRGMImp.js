(function(n){if(!n.version||n.version.major<2)throw new Error("This version of OpenSeadragonScalebar requires OpenSeadragon version 2.0.0+");n.Viewer.prototype.scalebar=function(e){this.scalebarInstance?this.scalebarInstance.refresh(e):(e=e||{},e.viewer=this,this.scalebarInstance=new n.Scalebar(e))},n.ScalebarType={NONE:0,MICROSCOPY:1,MAP:2},n.ScalebarLocation={NONE:0,TOP_LEFT:1,TOP_RIGHT:2,BOTTOM_RIGHT:3,BOTTOM_LEFT:4},n.Scalebar=function(e){if(e=e||{},!e.viewer)throw new Error("A viewer must be specified.");this.viewer=e.viewer,this.divElt=document.createElement("div"),this.viewer.container.appendChild(this.divElt),this.divElt.style.position="relative",this.divElt.style.margin="0",this.divElt.style.pointerEvents="none",this.setMinWidth(e.minWidth||"150px"),this.setDrawScalebarFunction(e.type||n.ScalebarType.MICROSCOPY),this.color=e.color||"black",this.fontColor=e.fontColor||"black",this.backgroundColor=e.backgroundColor||"none",this.fontSize=e.fontSize||"",this.fontFamily=e.fontFamily||"",this.barThickness=e.barThickness||2,this.pixelsPerMeter=e.pixelsPerMeter||null,this.referenceItemIdx=e.referenceItemIdx||0,this.location=e.location||n.ScalebarLocation.BOTTOM_LEFT,this.xOffset=e.xOffset||5,this.yOffset=e.yOffset||5,this.stayInsideImage=h(e.stayInsideImage)?e.stayInsideImage:!0,this.sizeAndTextRenderer=e.sizeAndTextRenderer||n.ScalebarSizeAndTextRenderer.METRIC_LENGTH;var t=this;this.viewer.addHandler("open",function(){t.refresh()}),this.viewer.addHandler("animation",function(){t.refresh()}),this.viewer.addHandler("resize",function(){t.refresh()})},n.Scalebar.prototype={updateOptions:function(e){e&&(h(e.type)&&this.setDrawScalebarFunction(e.type),h(e.minWidth)&&this.setMinWidth(e.minWidth),h(e.color)&&(this.color=e.color),h(e.fontColor)&&(this.fontColor=e.fontColor),h(e.backgroundColor)&&(this.backgroundColor=e.backgroundColor),h(e.fontSize)&&(this.fontSize=e.fontSize),h(e.fontFamily)&&(this.fontFamily=e.fontFamily),h(e.barThickness)&&(this.barThickness=e.barThickness),h(e.pixelsPerMeter)&&(this.pixelsPerMeter=e.pixelsPerMeter),h(e.referenceItemIdx)&&(this.referenceItemIdx=e.referenceItemIdx),h(e.location)&&(this.location=e.location),h(e.xOffset)&&(this.xOffset=e.xOffset),h(e.yOffset)&&(this.yOffset=e.yOffset),h(e.stayInsideImage)&&(this.stayInsideImage=e.stayInsideImage),h(e.sizeAndTextRenderer)&&(this.sizeAndTextRenderer=e.sizeAndTextRenderer))},setDrawScalebarFunction:function(e){e?e===n.ScalebarType.MAP?this.drawScalebar=this.drawMapScalebar:this.drawScalebar=this.drawMicroscopyScalebar:this.drawScalebar=null},setMinWidth:function(e){this.divElt.style.width=e,this.divElt.style.display="",this.minWidth=this.divElt.offsetWidth},refresh:function(e){if(this.updateOptions(e),!this.viewer.isOpen()||!this.drawScalebar||!this.pixelsPerMeter||!this.location){this.divElt.style.display="none";return}this.divElt.style.display="";var t=this.viewer.viewport,i=this.viewer.world.getItemAt(this.referenceItemIdx),r=w(i,t.getZoom(!0)),a=r*this.pixelsPerMeter,s=this.sizeAndTextRenderer(a,this.minWidth);this.drawScalebar(s.size,s.text);var f=this.getScalebarLocation();this.divElt.style.left=f.x+"px",this.divElt.style.top=f.y+"px"},drawMicroscopyScalebar:function(e,t){this.divElt.style.fontSize=this.fontSize,this.divElt.style.fontFamily=this.fontFamily,this.divElt.style.textAlign="center",this.divElt.style.color=this.fontColor,this.divElt.style.border="none",this.divElt.style.borderBottom=this.barThickness+"px solid "+this.color,this.divElt.style.backgroundColor=this.backgroundColor,this.divElt.innerHTML=t,this.divElt.style.width=e+"px"},drawMapScalebar:function(e,t){this.divElt.style.fontSize=this.fontSize,this.divElt.style.fontFamily=this.fontFamily,this.divElt.style.textAlign="center",this.divElt.style.color=this.fontColor,this.divElt.style.border=this.barThickness+"px solid "+this.color,this.divElt.style.borderTop="none",this.divElt.style.backgroundColor=this.backgroundColor,this.divElt.innerHTML=t,this.divElt.style.width=e+"px"},getScalebarLocation:function(){if(this.location===n.ScalebarLocation.TOP_LEFT){var e=0,t=0;if(this.stayInsideImage){var i=this.viewer.viewport.pixelFromPoint(new n.Point(0,0),!0);this.viewer.wrapHorizontal||(e=Math.max(i.x,0)),this.viewer.wrapVertical||(t=Math.max(i.y,0))}return new n.Point(e+this.xOffset,t+this.yOffset)}if(this.location===n.ScalebarLocation.TOP_RIGHT){var r=this.divElt.offsetWidth,a=this.viewer.container,e=a.offsetWidth-r,t=0;if(this.stayInsideImage){var i=this.viewer.viewport.pixelFromPoint(new n.Point(1,0),!0);this.viewer.wrapHorizontal||(e=Math.min(e,i.x-r)),this.viewer.wrapVertical||(t=Math.max(t,i.y))}return new n.Point(e-this.xOffset,t+this.yOffset)}if(this.location===n.ScalebarLocation.BOTTOM_RIGHT){var r=this.divElt.offsetWidth,s=this.divElt.offsetHeight,a=this.viewer.container,e=a.offsetWidth-r,t=a.offsetHeight-s;if(this.stayInsideImage){var i=this.viewer.viewport.pixelFromPoint(new n.Point(1,1/this.viewer.source.aspectRatio),!0);this.viewer.wrapHorizontal||(e=Math.min(e,i.x-r)),this.viewer.wrapVertical||(t=Math.min(t,i.y-s))}return new n.Point(e-this.xOffset,t-this.yOffset)}if(this.location===n.ScalebarLocation.BOTTOM_LEFT){var s=this.divElt.offsetHeight,a=this.viewer.container,e=0,t=a.offsetHeight-s;if(this.stayInsideImage){var i=this.viewer.viewport.pixelFromPoint(new n.Point(0,1/this.viewer.source.aspectRatio),!0);this.viewer.wrapHorizontal||(e=Math.max(e,i.x)),this.viewer.wrapVertical||(t=Math.min(t,i.y-s))}return new n.Point(e+this.xOffset,t-this.yOffset)}},getAsCanvas:function(){var e=document.createElement("canvas");e.width=this.divElt.offsetWidth,e.height=this.divElt.offsetHeight;var t=e.getContext("2d");t.fillStyle=this.backgroundColor,t.fillRect(0,0,e.width,e.height),t.fillStyle=this.color,t.fillRect(0,e.height-this.barThickness,e.width,e.height),this.drawScalebar===this.drawMapScalebar&&(t.fillRect(0,0,this.barThickness,e.height),t.fillRect(e.width-this.barThickness,0,this.barThickness,e.height)),t.font=window.getComputedStyle(this.divElt).font,t.textAlign="center",t.textBaseline="middle",t.fillStyle=this.fontColor;var i=e.width/2,r=e.height/2;return t.fillText(this.divElt.textContent,i,r),e},getImageWithScalebarAsCanvas:function(){var e=this.viewer.drawer.canvas,t=document.createElement("canvas");t.width=e.width,t.height=e.height;var i=t.getContext("2d");i.drawImage(e,0,0);var r=this.getAsCanvas(),a=this.getScalebarLocation();return i.drawImage(r,a.x,a.y),t}},n.ScalebarSizeAndTextRenderer={METRIC_LENGTH:function(e,t){return o(e,t,"m")},IMPERIAL_LENGTH:function(e,t){var i=t*2,r=e*.0254;if(i<r*12){if(i<r){var a=r/1e3;return l(a,t,"th")}return l(r,t,"in")}var s=r*12;if(i<s*2e3)return l(s,t,"ft");var f=s*5280;return l(f,t,"mi")},ASTRONOMY:function(e,t){var i=t*2;if(i<e*60)return l(e,t,'"',!1,"");var r=e*60;if(i<r*60)return l(r,t,"'",!1,"");var a=r*60;return l(a,t,"&#176",!1,"")},STANDARD_TIME:function(e,t){var i=t*2;if(i<e*60)return o(e,t,"s");var r=e*60;if(i<r*60)return l(r,t,"minute",!0);var a=r*60;if(i<a*24)return l(a,t,"hour",!0);var s=a*24;if(i<s*365.25)return l(s,t,"day",!0);var f=s*365.25;return l(f,t,"year",!0)},METRIC_GENERIC:o};function w(e,t){var i=e._scaleSpring.current.value*e.viewport._containerInnerSize.x/e.source.dimensions.x;return i*t}function l(e,t,i,r,a){a=a===void 0?" ":a;var s=d(e,t),f=v(s/e*t,3),g=s*t,x=r&&f>1?"s":"";return{size:g,text:f+a+i+x}}function o(e,t,i){var r=d(e,t),a=v(r/e*t,3),s=r*t,f=y(a,i);return{size:s,text:f}}function d(e,t){var i=c(e),r=c(t),a=c(i/r);return a>=5&&(a/=5),a>=4&&(a/=4),a>=2&&(a/=2),a}function c(e){return e*Math.pow(10,Math.ceil(-u(e)))}function v(e,t){var i=-Math.ceil(-u(e)),r=t-i,a=e*Math.pow(10,r);return r<0?Math.round(a)*Math.pow(10,-r):Math.round(a)/Math.pow(10,r)}function u(e){return Math.log(e)/Math.log(10)}function y(e,t){return e<1e-6?e*1e9+" n"+t:e<.001?e*1e6+" Î¼"+t:e<1?e*1e3+" m"+t:e>=1e3?e/1e3+" k"+t:e+" "+t}function h(e){return typeof e<"u"}})(OpenSeadragon);
